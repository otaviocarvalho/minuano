#!/usr/bin/env bash
# Claim a specific task by ID. Prints JSON or fails with a clear error.
set -euo pipefail

TASK_ID="${1:?Usage: minuano-pick <task-id>}"
AGENT_ID="${AGENT_ID:?AGENT_ID not set}"
DB="${DATABASE_URL:?DATABASE_URL not set}"

# Resolve partial ID â€” find the full task ID matching the prefix.
FULL_ID=$(psql "$DB" -t -A -c "SELECT id FROM tasks WHERE id LIKE '${TASK_ID}%' LIMIT 2")
COUNT=$(echo "$FULL_ID" | grep -c . || true)

if [ "$COUNT" -eq 0 ]; then
  echo "Error: no task found matching '$TASK_ID'" >&2
  exit 1
elif [ "$COUNT" -gt 1 ]; then
  echo "Error: ambiguous prefix '$TASK_ID' matches multiple tasks" >&2
  exit 1
fi

TASK_ID="$FULL_ID"

# Check task is claimable.
STATUS=$(psql "$DB" -t -A -c "SELECT status FROM tasks WHERE id='$TASK_ID'")
if [ "$STATUS" != "ready" ]; then
  echo "Error: task '$TASK_ID' is not ready (status: $STATUS)" >&2
  exit 1
fi

RESULT=$(psql "$DB" -t -A -c "
  WITH claimed AS (
    UPDATE tasks
    SET status='claimed', claimed_by='$AGENT_ID', claimed_at=NOW(),
        attempt = attempt + 1
    WHERE id='$TASK_ID'
      AND status='ready'
      AND attempt < max_attempts
    RETURNING *
  ),
  inherited AS (
    INSERT INTO task_context (task_id, agent_id, kind, content, source_task)
    SELECT c.id, '$AGENT_ID', 'inherited', tc.content, tc.task_id
    FROM claimed c
    JOIN task_deps td ON td.task_id = c.id
    JOIN task_context tc ON tc.task_id = td.depends_on
      AND tc.kind IN ('result','observation','handoff','test_failure')
    JOIN tasks dep ON dep.id = td.depends_on AND dep.status='done'
    RETURNING task_id
  ),
  agent_upd AS (
    UPDATE agents SET task_id=(SELECT id FROM claimed),
      status='working', last_seen=NOW() WHERE id='$AGENT_ID'
  )
  SELECT row_to_json(t) FROM (
    SELECT c.*,
      (SELECT json_agg(tc ORDER BY tc.created_at)
       FROM task_context tc WHERE tc.task_id = c.id) AS context
    FROM claimed c
  ) t;
")

if [ -z "$RESULT" ]; then
  echo "Error: failed to claim task '$TASK_ID' (may have reached max attempts)" >&2
  exit 1
fi

echo "$RESULT"
